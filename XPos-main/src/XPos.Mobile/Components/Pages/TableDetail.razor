@page "/table/{TableId:int}"
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthStateService Auth

<!-- Header -->
<div class="detail-header">
    <button class="back-btn" @onclick="GoBack">
        <MudIcon Icon="@Icons.Material.Filled.ArrowBackIosNew" Style="font-size:18px; color:white;" />
    </button>
    <div class="header-info">
        <h2 class="header-title">@(table?.TableNumber ?? "Masa")</h2>
        <span class="header-status @GetStatusClass()">@GetStatusText()</span>
    </div>
    <button class="action-btn" @onclick="LoadData">
        <MudIcon Icon="@Icons.Material.Filled.Refresh" Style="font-size:18px; color:white;" />
    </button>
</div>

@if (isLoading)
{
    <div class="loading-box">
        <MudProgressCircular Indeterminate="true" Size="Size.Large" Style="color:#818CF8;" />
    </div>
}
else if (order != null)
{
    <!-- QR Onay Alert -->
    @if (order.Status == OrderStatus.Pending)
    {
        <div class="pending-alert">
            <div class="pending-icon">
                <MudIcon Icon="@Icons.Material.Filled.QrCode2" Style="font-size:24px; color:#FBBF24;" />
            </div>
            <div class="pending-info">
                <div class="pending-title">QR Sipari≈ü Geldi!</div>
                <div class="pending-sub">M√º≈üteri men√ºden sipari≈ü olu≈üturdu</div>
            </div>
        </div>
        <div class="approval-btns">
            <button class="approve-btn reject" @onclick="RejectOrder">
                <MudIcon Icon="@Icons.Material.Filled.Close" Style="font-size:20px;" /> Reddet
            </button>
            <button class="approve-btn accept" @onclick="ApproveOrder">
                <MudIcon Icon="@Icons.Material.Filled.Check" Style="font-size:20px;" /> Onayla
            </button>
        </div>
    }

    <!-- Sipari≈ü Listesi -->
    <div class="order-list">
        <div class="section-title">
            <span>Sipari≈üler</span>
            <span class="item-count">@order.Items.Count √ºr√ºn</span>
        </div>

        @foreach (var item in order.Items)
        {
            <div class="order-item">
                <div class="item-qty">@item.Quantity</div>
                <div class="item-info">
                    <div class="item-name">@GetProductName(item.ProductId)</div>
                    @if (!string.IsNullOrEmpty(item.Note))
                    {
                        <div class="item-note">üìù @item.Note</div>
                    }
                    <div class="item-price-unit">@item.UnitPrice.ToString("N2") ‚Ç∫ / adet</div>
                </div>
                <div class="item-total">@((item.Quantity * item.UnitPrice).ToString("N2")) ‚Ç∫</div>
            </div>
        }
    </div>

    <!-- Total Card -->
    <div class="total-card">
        <div class="total-row">
            <span>Toplam</span>
            <span class="total-amount">@order.TotalAmount.ToString("N2") ‚Ç∫</span>
        </div>
        <div class="total-meta">
            <MudIcon Icon="@Icons.Material.Filled.AccessTime" Style="font-size:14px;" />
            @order.CreatedAt.ToString("HH:mm") ‚Ä¢ @Auth.WaiterName
        </div>
    </div>

    <!-- Bottom: √úr√ºn Ekle -->
    <div class="bottom-action">
        <button class="add-product-btn" @onclick="GoAddProduct">
            <MudIcon Icon="@Icons.Material.Filled.Add" Style="font-size:20px; color:white;" />
            <span>√úr√ºn Ekle</span>
        </button>
    </div>
}
else
{
    <!-- Bo≈ü Masa -->
    <div class="empty-state">
        <div class="empty-icon">
            <MudIcon Icon="@Icons.Material.Outlined.TableRestaurant" Style="font-size:56px; color:rgba(255,255,255,0.15);" />
        </div>
        <h3 class="empty-title">Bu masa bo≈ü</h3>
        <p class="empty-sub">Sipari≈ü olu≈üturmak i√ßin √ºr√ºn ekleyin</p>
        <button class="create-order-btn" @onclick="GoAddProduct">
            <MudIcon Icon="@Icons.Material.Filled.Add" Style="font-size:20px; color:white;" />
            Sipari≈ü Olu≈ütur
        </button>
    </div>
}

<style>
    .detail-header {
        display: flex; align-items: center; gap: 12px; padding: 16px;
        background: #1E293B; border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .back-btn, .action-btn {
        width: 40px; height: 40px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
        background: rgba(255,255,255,0.05); cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .back-btn:active, .action-btn:active { background: rgba(255,255,255,0.1); transform: scale(0.95); }
    .header-info { flex: 1; }
    .header-title { margin: 0; font-size: 18px; font-weight: 700; color: white; }
    .header-status {
        font-size: 11px; padding: 2px 8px; border-radius: 6px; display: inline-block; margin-top: 2px;
        font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .status-active { background: rgba(52,211,153,0.15); color: #34D399; }
    .status-pending { background: rgba(251,191,36,0.15); color: #FBBF24; }
    .status-empty { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.4); }
    .status-closed { background: rgba(100,116,139,0.2); color: #94A3B8; }

    .loading-box { display: flex; justify-content: center; padding: 64px; }

    .pending-alert {
        display: flex; align-items: center; gap: 12px; margin: 16px; padding: 14px;
        background: rgba(251,191,36,0.08); border: 1px solid rgba(251,191,36,0.2); border-radius: 16px;
    }
    .pending-icon {
        width: 44px; height: 44px; border-radius: 12px; background: rgba(251,191,36,0.15);
        display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .pending-title { font-size: 14px; font-weight: 700; color: #FBBF24; }
    .pending-sub { font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 2px; }

    .approval-btns { display: flex; gap: 8px; margin: 0 16px 12px; }
    .approve-btn {
        flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;
        padding: 12px; border-radius: 12px; font-size: 14px; font-weight: 700; border: none; cursor: pointer;
    }
    .approve-btn:active { transform: scale(0.97); }
    .approve-btn.reject { background: rgba(239,68,68,0.15); color: #F87171; }
    .approve-btn.accept { background: linear-gradient(135deg, #34D399, #10B981); color: white; }

    .order-list { padding: 0 16px; }
    .section-title {
        display: flex; justify-content: space-between; align-items: center;
        padding: 12px 0 8px; font-size: 12px; color: rgba(255,255,255,0.4);
        text-transform: uppercase; letter-spacing: 1px; font-weight: 600;
    }
    .item-count { color: #818CF8; }

    .order-item {
        display: flex; align-items: flex-start; gap: 12px; padding: 12px;
        background: #1E293B; border-radius: 14px; margin-bottom: 8px;
        border: 1px solid rgba(255,255,255,0.04);
    }
    .item-qty {
        width: 32px; height: 32px; border-radius: 8px; background: rgba(129,140,248,0.15);
        color: #818CF8; font-weight: 800; font-size: 14px;
        display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .item-info { flex: 1; min-width: 0; }
    .item-name { font-size: 14px; font-weight: 600; color: white; }
    .item-note { font-size: 11px; color: #F87171; margin-top: 3px; }
    .item-price-unit { font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 2px; }
    .item-total { font-size: 14px; font-weight: 700; color: #34D399; white-space: nowrap; }

    .total-card {
        margin: 12px 16px; padding: 16px; border-radius: 16px;
        background: linear-gradient(135deg, rgba(99,102,241,0.15) 0%, rgba(139,92,246,0.08) 100%);
        border: 1px solid rgba(99,102,241,0.2);
    }
    .total-row { display: flex; justify-content: space-between; align-items: center; }
    .total-row span:first-child { font-size: 14px; color: rgba(255,255,255,0.6); }
    .total-amount { font-size: 22px; font-weight: 800; color: white; }
    .total-meta {
        display: flex; align-items: center; gap: 4px; margin-top: 8px;
        font-size: 11px; color: rgba(255,255,255,0.3);
    }

    .bottom-action {
        padding: 12px 16px 20px; position: sticky; bottom: 0;
        background: linear-gradient(0deg, #0F172A 60%, transparent);
    }
    .add-product-btn {
        width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;
        padding: 14px; border-radius: 14px; border: none; cursor: pointer;
        background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white;
        font-size: 15px; font-weight: 700; box-shadow: 0 4px 24px rgba(99,102,241,0.3);
    }
    .add-product-btn:active { transform: scale(0.97); }

    .empty-state {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 64px 24px; text-align: center; flex: 1;
    }
    .empty-icon {
        width: 100px; height: 100px; border-radius: 24px; background: rgba(255,255,255,0.03);
        display: flex; align-items: center; justify-content: center; margin-bottom: 16px;
    }
    .empty-title { color: white; font-size: 18px; font-weight: 700; margin: 0 0 4px; }
    .empty-sub { color: rgba(255,255,255,0.3); font-size: 13px; margin: 0 0 24px; }
    .create-order-btn {
        display: flex; align-items: center; gap: 8px; padding: 14px 32px;
        border-radius: 14px; border: none; cursor: pointer;
        background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white;
        font-size: 15px; font-weight: 700; box-shadow: 0 4px 24px rgba(99,102,241,0.3);
    }
    .create-order-btn:active { transform: scale(0.97); }
</style>

@code {
    [Parameter] public int TableId { get; set; }

    private TableDto? table;
    private OrderDto? order;
    private List<ProductDto>? products;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            table = await Http.GetFromJsonAsync<TableDto>($"api/tables/{TableId}");
            products = await Http.GetFromJsonAsync<List<ProductDto>>("api/products");
            
            // Aktif konsolide sipari≈üi √ßek
            if (table != null)
            {
                var response = await Http.GetAsync($"api/orders/active/{table.TableNumber}");
                if (response.IsSuccessStatusCode)
                {
                    order = await response.Content.ReadFromJsonAsync<OrderDto>();
                }
                else
                {
                    order = null;
                }
            }
            else
            {
                order = null;
            }
        }
        catch { }
        finally { isLoading = false; }
    }

    private string GetProductName(int id) => products?.FirstOrDefault(p => p.Id == id)?.Name ?? $"√úr√ºn #{id}";

    private string GetStatusClass()
    {
        if (order == null) return "status-empty";
        return order.Status switch
        {
            OrderStatus.Pending => "status-pending",
            OrderStatus.Confirmed or OrderStatus.Preparing => "status-active",
            _ => "status-closed"
        };
    }

    private string GetStatusText()
    {
        if (order == null) return "Bo≈ü";
        return order.Status switch
        {
            OrderStatus.Pending => "Onay Bekliyor",
            OrderStatus.Confirmed => "Aktif",
            OrderStatus.Preparing => "Hazƒ±rlanƒ±yor",
            OrderStatus.Ready => "Hazƒ±r",
            OrderStatus.Paid => "√ñdendi",
            OrderStatus.Cancelled => "ƒ∞ptal",
            _ => "‚Äî"
        };
    }

    private void GoBack() => Nav.NavigateTo("/");
    private void GoAddProduct() => Nav.NavigateTo($"/table/{TableId}/add");

    private async Task ApproveOrder()
    {
        if (order == null) return;
        await Http.PutAsJsonAsync($"api/orders/{order.Id}/status", (int)OrderStatus.Confirmed);
        await LoadData();
    }

    private async Task RejectOrder()
    {
        if (order == null) return;
        await Http.PutAsJsonAsync($"api/orders/{order.Id}/status", (int)OrderStatus.Cancelled);
        await LoadData();
    }
}
