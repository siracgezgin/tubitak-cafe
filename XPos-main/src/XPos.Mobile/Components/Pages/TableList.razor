@page "/tables"
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@inject HttpClient Http
@inject OrderStateService OrderState
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@implements IDisposable

<div class="d-flex flex-column h-100">
    <!-- Header with Stats -->
    <div class="top-bar px-4 py-3 h-auto d-block">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2 class="m-0 fw-bold">Anlık Masa Durumu</h2>
                <p class="text-muted m-0 small">@tables.Count(t => t.IsOccupied) Dolu / @tables.Count Toplam</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-icon" @onclick="LoadTables" title="Yenile">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
                <div class="d-flex align-items-center gap-2 px-3 py-2 rounded-pill bg-surface border border-secondary">
                    <div class="spinner-grow spinner-grow-sm @(isConnected ? "text-success" : "text-danger")" role="status"></div>
                    <small class="fw-bold @(isConnected ? "text-success" : "text-danger")">
                        @(isConnected ? "CANLI" : "KOPUK")
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Quick Filters/Legend -->
        <div class="d-flex gap-3 overflow-auto pb-2">
            <span class="badge bg-success-subtle text-success border border-success px-3 py-2 rounded-pill">
                <i class="bi bi-shop me-1"></i> Boş (@tables.Count(t => !t.IsOccupied && !t.HasPendingOrder))
            </span>
            <span class="badge bg-danger-subtle text-danger border border-danger px-3 py-2 rounded-pill">
                <i class="bi bi-person-fill me-1"></i> Dolu (@tables.Count(t => t.IsOccupied))
            </span>
            <span class="badge bg-warning-subtle text-warning border border-warning px-3 py-2 rounded-pill">
                <i class="bi bi-bell-fill me-1"></i> Sipariş (@tables.Count(t => t.HasPendingOrder))
            </span>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content bg-body p-4">
        @if (lastOrderMessage != null)
        {
            <div class="alert alert-warning shadow-lg border-0 d-flex align-items-center justify-content-between mb-4 animation-slide-down" role="alert">
                <div class="d-flex align-items-center">
                    <div class="bg-warning text-dark p-2 rounded-circle me-3">
                        <i class="bi bi-bell-fill fs-4"></i>
                    </div>
                    <div>
                        <h5 class="alert-heading fw-bold mb-0">Yeni Sipariş!</h5>
                        <p class="mb-0 text-dark opacity-75">@lastOrderMessage</p>
                    </div>
                </div>
                <button type="button" class="btn-close" @onclick="() => lastOrderMessage = null"></button>
            </div>
        }

        @if (isLoading)
        {
            <div class="d-flex justify-content-center align-items-center h-50">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
            </div>
        }
        else if (errorMessage != null)
        {
             <div class="alert alert-danger shadow-sm">
                <i class="bi bi-exclamation-octagon-fill me-2"></i> @errorMessage
            </div>
        }
        else
        {
            <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-4">
                @foreach (var table in tables)
                {
                    <div class="col">
                        <!-- Table Card -->
                        <div class="card h-100 border-0 shadow-sm table-card position-relative overflow-hidden cursor-pointer @GetCardClass(table)"
                             @onclick="() => HandleTableClick(table)">
                            
                            <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center text-center py-5">
                                <h3 class="fw-bold mb-1">@table.TableNumber</h3>
                                <small class="text-white opacity-50 mb-3">@table.Capacity Kişilik</small>

                                @if (table.HasPendingOrder)
                                {
                                    <div class="badge bg-warning text-dark mb-2 px-3 py-2 rounded-pill animation-pulse">
                                        <i class="bi bi-bell-fill me-1"></i> ONAYLA
                                    </div>
                                }
                                else if (table.IsOccupied)
                                {
                                    <div class="badge bg-black bg-opacity-25 mb-2 px-3 py-2 rounded-pill">
                                        @((table.CurrentOrderAmount ?? 0).ToString("C2"))
                                    </div>
                                }
                                else
                                {
                                    <i class="bi bi-shop fs-1 opacity-25"></i>
                                }
                            </div>
                            
                            <!-- Action Overlay (Visible on Hover/Click context could be added) -->
                            @if (table.HasPendingOrder || table.IsOccupied) 
                            {
                                <div class="card-footer border-0 bg-black bg-opacity-10 p-2">
                                    <div class="d-flex gap-2">
                                        @if(table.HasPendingOrder) {
                                            <button class="btn btn-sm btn-success flex-grow-1 fw-bold" @onclick:stopPropagation="true" @onclick="() => ApproveOrder(table.CurrentOrderId)">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger flex-grow-1 fw-bold" @onclick:stopPropagation="true" @onclick="() => RejectOrder(table.CurrentOrderId)">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        } else {
                                            <button class="btn btn-sm btn-light bg-opacity-10 text-white border-0 flex-grow-1" @onclick:stopPropagation="true" @onclick="() => ShowOrderDetails(table.CurrentOrderId)">ADİSYON</button>
                                            <button class="btn btn-sm btn-success flex-grow-1" @onclick:stopPropagation="true" @onclick="() => ShowOrderDetails(table.CurrentOrderId)">ÖDEME</button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

<style>
    .table-card { 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        cursor: pointer;
        min-height: 200px;
    }
    .table-card:hover { 
        transform: translateY(-5px); 
        box-shadow: 0 10px 20px rgba(0,0,0,0.3) !important;
    }
    
    .bg-surface { background-color: var(--bg-surface); }
    
    .status-empty { background-color: var(--bg-surface); border: 2px dashed var(--border-color) !important; color: var(--text-muted); }
    .status-occupied { background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white; }
    .status-pending { background: linear-gradient(135deg, var(--warning) 0%, #f39c12 100%); color: black; }
    
    .animation-pulse { animation: pulse 2s infinite; }
    @@keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 165, 2, 0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 165, 2, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 165, 2, 0); }
    }
    
    .animation-slide-down { animation: slideDown 0.5s ease-out; }
    @@keyframes slideDown {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

    <!-- Confirmation Modal -->
    @if (showConfirmationModal)
    {
        <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold">@confirmationTitle</h5>
                        <button type="button" class="btn-close" @onclick="CloseModal"></button>
                    </div>
                    <div class="modal-body py-4 text-center">
                        <i class="bi @confirmationIcon fs-1 text-@confirmationColor mb-3 d-block"></i>
                        <p class="mb-0 fs-5">@confirmationMessage</p>
                    </div>
                    <div class="modal-footer border-0 pt-0 justify-content-center">
                        <button type="button" class="btn btn-light px-4" @onclick="CloseModal">İptal</button>
                        <button type="button" class="btn btn-@confirmationColor px-4 fw-bold" @onclick="ConfirmAction">Onayla</button>
                    </div>
                </div>
            </div>
        </div>
    }

@code {
    private List<TableDto> tables = new();
    private bool isLoading = true;
    private string? errorMessage;
    private bool isConnected => OrderState.IsConnected;
    private string? lastOrderMessage;

    // Modal State
    private bool showConfirmationModal = false;
    private string confirmationTitle = "";
    private string confirmationMessage = "";
    private string confirmationIcon = "";
    private string confirmationColor = "primary";
    private Func<Task>? pendingAction;

    protected override async Task OnInitializedAsync()
    {
        await LoadTables();
        await OrderState.StartConnection();
        OrderState.OnOrderReceived += HandleOrderReceived;
        _ = PeriodicRefresh();
    }
    
    // ... Existing PeriodicRefresh and HandleOrderReceived ...
    private async Task PeriodicRefresh()
    {
        using var timer = new PeriodicTimer(TimeSpan.FromSeconds(5));
        while (await timer.WaitForNextTickAsync())
        {
            StateHasChanged();
        }
    }

    private void HandleOrderReceived(OrderDto order)
    {
        lastOrderMessage = $"Masa {order.TableNumber} sipariş verdi! ({order.TotalAmount:C2})";
        InvokeAsync(async () => 
        {
            await LoadTables();
            StateHasChanged();
        });
    }

    private async Task LoadTables()
    {
        errorMessage = null;
        try
        {
            tables = await Http.GetFromJsonAsync<List<TableDto>>("api/tables") ?? new();
        }
        catch (Exception ex)
        {
            errorMessage = $"Veri hatası: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
        StateHasChanged();
    }
    
    private string GetCardClass(TableDto table)
    {
        if (table.HasPendingOrder) return "status-pending border-warning";
        if (table.IsOccupied) return "status-occupied border-danger";
        return "status-empty";
    }

    private void HandleTableClick(TableDto table)
    {
        if (table.HasPendingOrder || table.IsOccupied)
        {
            ShowOrderDetails(table.CurrentOrderId);
        }
    }
    
    // Confirmation Logic
    private void ShowConfirmation(string title, string message, string icon, string color, Func<Task> action)
    {
        confirmationTitle = title;
        confirmationMessage = message;
        confirmationIcon = icon;
        confirmationColor = color;
        pendingAction = action;
        showConfirmationModal = true;
    }

    private void CloseModal() => showConfirmationModal = false;

    private async Task ConfirmAction()
    {
        if (pendingAction != null)
        {
            await pendingAction.Invoke();
        }
        CloseModal();
    }

    // Actions
    private async Task ApproveOrder(int? orderId)
    {
        // Direct approval usually doesn't need confirmation, but let's keep it fast
        await UpdateOrderStatus(orderId, 1);
    }

    private void RejectOrder(int? orderId)
    {
        ShowConfirmation(
            "Siparişi Reddet", 
            "Bu siparişi reddetmek istediğinize emin misiniz?", 
            "bi-x-circle-fill", 
            "danger", 
            async () => await UpdateOrderStatus(orderId, 6)
        );
    }

    private void TakePayment(int? orderId)
    {
        ShowConfirmation(
            "Ödeme Al", 
            "Ödeme alındı ve masa kapatılacak. Onaylıyor musunuz?", 
            "bi-cash-coin", 
            "success", 
            async () => await UpdateOrderStatus(orderId, 5) // Assuming 5 is Paid/Closed
        );
    }
    
    private async Task UpdateOrderStatus(int? orderId, int statusId)
    {
        if (orderId == null) return;
        try
        {
            var response = await Http.PutAsJsonAsync($"api/orders/{orderId}/status", statusId);
            if (response.IsSuccessStatusCode)
            {
                await LoadTables();
            }
            else
            {
                errorMessage = "İşlem başarısız.";
            }
        }
        catch (Exception ex)
        {
             errorMessage = $"Hata: {ex.Message}";
        }
    }
    
    private void ShowOrderDetails(int? orderId)
    {
        if(orderId.HasValue)
             NavigationManager.NavigateTo($"/order-details/{orderId}");
    }

    public void Dispose()
    {
        OrderState.OnOrderReceived -= HandleOrderReceived;
    }
}
