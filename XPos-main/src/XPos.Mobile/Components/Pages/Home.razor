@page "/"
@using MudBlazor
@using XPos.Shared.DTOs
@using XPos.Shared.Enums
@inject AuthStateService AuthService
@inject NavigationManager Nav
@inject HttpClient Http

@if (!IsDesktop)
{
    <WaiterTables />
}
else
{
    <div class="dashboard-container">
        <div class="d-flex justify-space-between align-center mb-6">
            <div class="d-flex align-center gap-4">
                <MudText Typo="Typo.h4" Class="fw-bold">Dashboard</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Default" OnClick="LoadDashboardData" Size="Size.Small" />
            </div>
            <div class="d-flex gap-3">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.QrCode" OnClick='() => Nav.NavigateTo("/desktop/menu")' Style="border-radius:10px; text-transform:none;">QR Menü Yönetimi</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.TableChart" OnClick='() => Nav.NavigateTo("/desktop/tables")' Style="border-radius:10px; text-transform:none;">Masa Yönetimi</MudButton>
            </div>
        </div>

        <MudGrid>
            <!-- Stats -->
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4 d-flex align-center gap-4" Elevation="1">
                    <div class="stat-icon orange">
                        <MudIcon Icon="@Icons.Material.Filled.TableRestaurant" />
                    </div>
                    <div>
                        <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Dolu Masalar</MudText>
                        <MudText Typo="Typo.h5">@occupiedTables / @totalTables</MudText>
                    </div>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4 d-flex align-center gap-4" Elevation="1">
                    <div class="stat-icon green">
                        <MudIcon Icon="@Icons.Material.Filled.Payments" />
                    </div>
                    <div>
                        <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Günlük Ciro</MudText>
                        <MudText Typo="Typo.h5">@dailyRevenue.ToString("N2") TL</MudText>
                    </div>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4 d-flex align-center gap-4" Elevation="1">
                    <div class="stat-icon blue">
                        <MudIcon Icon="@Icons.Material.Filled.ReceiptLong" />
                    </div>
                    <div>
                        <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Bekleyen Sipariş</MudText>
                        <MudText Typo="Typo.h5">@pendingOrders</MudText>
                    </div>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4 d-flex align-center gap-4" Elevation="1">
                    <div class="stat-icon purple">
                        <MudIcon Icon="@Icons.Material.Filled.Star" />
                    </div>
                    <div>
                        <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Popüler Ürün</MudText>
                        <MudText Typo="Typo.h5">Burger</MudText>
                    </div>
                </MudPaper>
            </MudItem>

            <!-- Recent Orders -->
            <MudItem xs="12" md="8">
                <MudPaper Class="pa-4" Elevation="1">
                    <div class="d-flex align-center justify-space-between mb-4">
                        <MudText Typo="Typo.h6">Son Siparişler</MudText>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick='() => Nav.NavigateTo("/d/orders")'>Tümünü Gör</MudButton>
                    </div>
                    <MudTable Items="@recentOrders" Hover="true" Elevation="0" Dense="true">
                        <HeaderContent>
                            <MudTh>Masa</MudTh>
                            <MudTh>Tutar</MudTh>
                            <MudTh>Durum</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.TableNumber</MudTd>
                            <MudTd>@context.TotalAmount.ToString("N2") TL</MudTd>
                            <MudTd>
                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)" Variant="Variant.Text" Label="true">@context.Status</MudChip>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudPaper>
            </MudItem>

            <!-- Info Panel -->
            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4" Elevation="1">
                    <MudText Typo="Typo.h6" Class="mb-4">Hızlı Erişim</MudText>
                    <div class="d-flex flex-column gap-2">
                        <MudButton Variant="Variant.Outlined" FullWidth="true" StartIcon="@Icons.Material.Filled.Add" OnClick='() => Nav.NavigateTo("/d/products")'>Hızlı Ürün Ekle</MudButton>
                        <MudButton Variant="Variant.Outlined" FullWidth="true" StartIcon="@Icons.Material.Filled.BarChart" OnClick='() => Nav.NavigateTo("/d/reports")'>Satış Raporları</MudButton>
                        <MudDivider Class="my-2" />
                        <div class="pa-2 mud-alert-info rounded">
                            <MudText Typo="Typo.body2">Sistem bugün sorunsuz çalışıyor. Toplam @totalTables masa aktif.</MudText>
                        </div>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </div>
}

<style>
    .dashboard-container { padding-bottom: 40px; }
    .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; }
    .stat-icon.orange { background: #FF9800; }
    .stat-icon.green { background: #4CAF50; }
    .stat-icon.blue { background: #2196F3; }
    .stat-icon.purple { background: #9C27B0; }
    .fw-bold { font-weight: 700; }
</style>

@code {
    private bool IsDesktop =>
         DeviceInfo.Current.Platform == DevicePlatform.WinUI ||
         DeviceInfo.Current.Platform == DevicePlatform.macOS;

    private int totalTables = 0;
    private int occupiedTables = 0;
    private int pendingOrders = 0;
    private decimal dailyRevenue = 0;
    private List<OrderDto> recentOrders = new();

    protected override async Task OnInitializedAsync()
    {
        if (IsDesktop)
        {
            await LoadDashboardData();
        }
    }

    private async Task LoadDashboardData()
    {
        try
        {
            var tables = await Http.GetFromJsonAsync<List<TableDto>>("api/tables") ?? new();
            totalTables = tables.Count;
            occupiedTables = tables.Count(t => t.IsOccupied);

            var orders = await Http.GetFromJsonAsync<List<OrderDto>>("api/orders") ?? new();
            pendingOrders = orders.Count(o => o.Status == OrderStatus.Pending);
            var today = DateTime.Today;
            dailyRevenue = orders
                .Where(o => o.Status == OrderStatus.Paid && o.CreatedAt.Date == today)
                .Sum(o => o.TotalAmount);
            recentOrders = orders.OrderByDescending(o => o.CreatedAt).Take(5).ToList();
        }
        catch { }
    }

    private Color GetStatusColor(OrderStatus s) => s switch
    {
        OrderStatus.Pending => Color.Warning,
        OrderStatus.Confirmed or OrderStatus.Preparing or OrderStatus.Ready => Color.Success,
        OrderStatus.Paid => Color.Info,
        OrderStatus.Cancelled => Color.Error,
        _ => Color.Default
    };
}
