@page "/desktop/station"
@using Microsoft.AspNetCore.SignalR.Client
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h4" Class="fw-bold">İstasyon Paneli (KDS)</MudText>
            <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">Hazırlanacak Ürünler ve Sipariş Takibi</MudText>
        </div>
        <div class="d-flex gap-4">
            <MudSelect T="int" Label="İstasyon Seçiniz" Value="@currentStationId" ValueChanged="OnStationChanged" Variant="Variant.Outlined" Dense="true" Style="width: 200px; background: white;">
                <MudSelectItem Value="1">Mutfak Panel</MudSelectItem>
                <MudSelectItem Value="2">Bar Panel</MudSelectItem>
            </MudSelect>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" OnClick="LoadItems" Color="Color.Primary" />
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-center align-center h-60">
            <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
        </div>
    }
    else if (!activeItems.Any())
    {
        <div class="d-flex flex-column align-center justify-center mt-16 opacity-50">
            <MudIcon Icon="@Icons.Material.Filled.TaskAlt" Style="font-size: 80px;" />
            <MudText Typo="Typo.h5" Class="mt-4">Şu an bekleyen sipariş yok.</MudText>
        </div>
    }
    else
    {
        <div class="kds-grid">
            @foreach (var item in activeItems)
            {
                <MudPaper Class="kds-card pa-4" Elevation="3">
                    <div class="d-flex justify-space-between align-center mb-2">
                        <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Filled">#@item.OrderId</MudChip>
                        <MudText Typo="Typo.h6" Color="Color.Primary" Class="fw-bold">@item.TableNumber</MudText>
                    </div>
                    
                    <MudDivider Class="my-2" />
                    
                    <div class="item-content py-2">
                        <MudText Typo="Typo.h5" Class="fw-bold">@item.Quantity x @item.ProductName</MudText>
                        @if (!string.IsNullOrEmpty(item.Note))
                        {
                            <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2 py-0 px-2" NoIcon="true">
                                <MudText Typo="Typo.body2"><b>NOT:</b> @item.Note</MudText>
                            </MudAlert>
                        }
                    </div>

                    <MudDivider Class="my-2" />

                    <div class="d-flex gap-2 mt-4">
                        @if (item.StationStatus == OrderStatus.Pending || item.StationStatus == OrderStatus.Confirmed)
                        {
                            <MudButton Variant="Variant.Filled" Color="Color.Warning" FullWidth="true" 
                                       StartIcon="@Icons.Material.Filled.PlayArrow" 
                                       OnClick="@(() => UpdateStatus(item.Id, OrderStatus.Preparing))">
                                BAŞLA
                            </MudButton>
                        }
                        else if (item.StationStatus == OrderStatus.Preparing)
                        {
                            <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" 
                                       StartIcon="@Icons.Material.Filled.CheckCircle" 
                                       OnClick="@(() => UpdateStatus(item.Id, OrderStatus.Ready))">
                                HAZIR
                            </MudButton>
                        }
                    </div>
                </MudPaper>
            }
        </div>
    }
</MudContainer>

<style>
    .kds-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }
    .kds-card {
        border-radius: 16px;
        transition: transform 0.2s;
        border-left: 6px solid var(--mud-palette-primary);
    }
    .kds-card:hover {
        transform: translateY(-4px);
    }
    .fw-bold { font-weight: 700; }
</style>

@code {
    private List<OrderItemDto> activeItems = new();
    private bool isLoading = true;
    private int currentStationId = 1; // Default Kitchen
    private HubConnection? hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadItems();
        await StartSignalR();
    }

    private async Task OnStationChanged(int stationId)
    {
        currentStationId = stationId;
        await LoadItems();
    }

    private async Task LoadItems()
    {
        isLoading = true;
        try
        {
            activeItems = await Http.GetFromJsonAsync<List<OrderItemDto>>($"api/station/{currentStationId}/active-items") ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Siparişler yüklenemedi: " + ex.Message, Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task UpdateStatus(int itemId, OrderStatus status)
    {
        try
        {
            var response = await Http.PutAsJsonAsync($"api/orders/item/{itemId}/status", (int)status);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Durum güncellendi", Severity.Success);
                await LoadItems();
            }
            else
            {
                Snackbar.Add("Hata oluştu", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("İşlem başarısız: " + ex.Message, Severity.Error);
        }
    }

    private async Task StartSignalR()
    {
        var baseUri = Http.BaseAddress?.ToString() ?? "http://localhost:5029/";
        hubConnection = new HubConnectionBuilder()
            .WithUrl(baseUri + "orderhub")
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<OrderDto>("OrderReceived", (order) =>
        {
            InvokeAsync(async () =>
            {
                // Yeni sipariş geldiğinde eğer bizim istasyona ait ürün varsa listeyi yenile
                await LoadItems();
                StateHasChanged();
            });
        });

        await hubConnection.StartAsync();
    }

    public void Dispose()
    {
        _ = hubConnection?.DisposeAsync();
    }
}
