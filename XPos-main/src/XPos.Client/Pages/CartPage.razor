@page "/cart"
@using XPos.Client.Services
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop

@inject CartService CartService
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Sepetim | Lezzet Duraƒüƒ±</PageTitle>

<div class="cart-page">
    <!-- Header -->
    <div class="cart-header">
        <a href="/" class="cart-back-btn">
            <MudIcon Icon="@Icons.Material.Filled.ArrowBackIos" Size="Size.Small" />
        </a>
        <h1 class="cart-page-title">Sepetim</h1>
        @if (CartService.Items.Any())
        {
            <span class="cart-item-count">@CartService.Items.Sum(i => i.Quantity) √ºr√ºn</span>
        }
    </div>

    @if (!CartService.Items.Any())
    {
        <div class="cart-empty">
            <div class="cart-empty-icon">üõí</div>
            <h2 class="cart-empty-title">Sepetiniz Bo≈ü</h2>
            <p class="cart-empty-desc">Lezzetli yemeklerimizden sepetinize ekleyin!</p>
            <a href="/" class="cart-browse-btn">
                <MudIcon Icon="@Icons.Material.Filled.RestaurantMenu" Size="Size.Small" />
                <span>Men√ºye D√∂n</span>
            </a>
        </div>
    }
    else
    {
        <div class="cart-content">
            <!-- Cart Items -->
            <div class="cart-items-section">
                @foreach (var item in CartService.Items)
                {
                    <div class="cart-item">
                        <div class="cart-item-img-wrapper">
                            @if (!string.IsNullOrEmpty(item.Product.ImageUrl))
                            {
                                <img src="@item.Product.ImageUrl" class="cart-item-img" alt="@item.Product.Name" />
                            }
                            else
                            {
                                <div class="cart-item-img-placeholder">
                                    <MudIcon Icon="@Icons.Material.Outlined.Restaurant" />
                                </div>
                            }
                        </div>
                        <div class="cart-item-details">
                            <div class="cart-item-top">
                                <h3 class="cart-item-name">@item.Product.Name</h3>
                                <button class="cart-item-remove" @onclick="@(() => CartService.RemoveFromCart(item.Product))">
                                    <MudIcon Icon="@Icons.Material.Outlined.Close" Size="Size.Small" />
                                </button>
                            </div>
                            <span class="cart-item-unit-price">‚Ç∫@item.Product.Price.ToString("N0")</span>

                            <MudTextField @bind-Value="item.Note" Placeholder="Not ekle (√∂rn: acƒ±sƒ±z)"
                                          Variant="Variant.Text" Margin="Margin.Dense" Class="cart-note-input"
                                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Outlined.EditNote" />

                            <div class="cart-item-bottom">
                                <div class="cart-qty-controls">
                                    <button class="cart-qty-btn" @onclick="@(() => CartService.DecreaseQuantity(item.Product))">
                                        <MudIcon Icon="@Icons.Material.Filled.Remove" Size="Size.Small" />
                                    </button>
                                    <span class="cart-qty-value">@item.Quantity</span>
                                    <button class="cart-qty-btn cart-qty-plus" @onclick="@(() => CartService.IncreaseQuantity(item.Product))">
                                        <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" />
                                    </button>
                                </div>
                                <span class="cart-item-total">‚Ç∫@((item.Product.Price * item.Quantity).ToString("N0"))</span>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Order Summary (Sticky) -->
            <div class="cart-summary-card">
                <h3 class="cart-summary-title">Sipari≈ü √ñzeti</h3>

                <div class="cart-summary-row">
                    <span>Ara Toplam</span>
                    <span class="cart-summary-value">‚Ç∫@CartService.TotalPrice.ToString("N0")</span>
                </div>
                <div class="cart-summary-row">
                    <span>Hizmet Bedeli</span>
                    <span class="cart-summary-free">√úcretsiz</span>
                </div>
                <div class="cart-summary-divider"></div>
                <div class="cart-summary-row cart-summary-total">
                    <span>Toplam</span>
                    <span>‚Ç∫@CartService.TotalPrice.ToString("N0")</span>
                </div>

                <MudTextField @bind-Value="TableNumber" Label="Masa Numarasƒ±" Variant="Variant.Outlined"
                              ReadOnly="@isTableReadOnly" Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.TableRestaurant"
                              Class="cart-table-input" />

                <button class="cart-submit-btn" @onclick="SubmitOrder" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <div class="cart-submit-spinner"></div>
                        <span>G√∂nderiliyor...</span>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Send" Size="Size.Small" />
                        <span>Sipari≈üi Onayla</span>
                        <span class="cart-submit-price">‚Ç∫@CartService.TotalPrice.ToString("N0")</span>
                    }
                </button>
            </div>
        </div>
    }
</div>

<style>
    .cart-page { padding: 0 0 120px 0; max-width: 680px; margin: 0 auto; }

    /* Header */
    .cart-header {
        display: flex; align-items: center; gap: 12px;
        padding: 16px 16px 8px; position: sticky; top: 56px; z-index: 50;
        background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
    }
    .cart-back-btn {
        width: 36px; height: 36px; border-radius: 10px; border: 1.5px solid #E5E7EB;
        display: flex; align-items: center; justify-content: center;
        color: #374151; text-decoration: none; transition: all 0.2s;
    }
    .cart-back-btn:hover { border-color: #FF5500; color: #FF5500; }
    .cart-page-title {
        font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 800;
        color: #111827; flex: 1; margin: 0;
    }
    .cart-item-count {
        font-size: 0.8rem; font-weight: 600; color: #FF5500;
        background: rgba(255,85,0,0.1); padding: 4px 12px; border-radius: 12px;
    }

    /* Empty State */
    .cart-empty {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 80px 20px; text-align: center;
    }
    .cart-empty-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.4; }
    .cart-empty-title { font-family: 'Outfit', sans-serif; font-size: 1.4rem; font-weight: 700; color: #111827; margin: 0 0 8px; }
    .cart-empty-desc { color: #6B7280; font-size: 0.9rem; margin: 0 0 24px; }
    .cart-browse-btn {
        display: flex; align-items: center; gap: 8px; padding: 12px 24px;
        background: linear-gradient(135deg, #FF5500, #FF7A33); color: white;
        border-radius: 12px; font-weight: 700; text-decoration: none;
        box-shadow: 0 4px 14px rgba(255,85,0,0.3); transition: all 0.2s;
    }
    .cart-browse-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,85,0,0.4); }

    /* Cart Content */
    .cart-content { padding: 0 16px; }

    /* Cart Item */
    .cart-item {
        display: flex; gap: 14px; background: white; border-radius: 16px;
        padding: 14px; margin-bottom: 12px;
        border: 1px solid #F3F4F6; transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .cart-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

    .cart-item-img-wrapper {
        width: 80px; height: 80px; border-radius: 12px; overflow: hidden; flex-shrink: 0;
    }
    .cart-item-img { width: 100%; height: 100%; object-fit: cover; }
    .cart-item-img-placeholder {
        width: 100%; height: 100%; background: #F3F4F6;
        display: flex; align-items: center; justify-content: center; color: #9CA3AF;
    }

    .cart-item-details { flex: 1; min-width: 0; display: flex; flex-direction: column; }
    .cart-item-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .cart-item-name { font-size: 0.95rem; font-weight: 700; color: #111827; margin: 0; line-height: 1.2; }
    .cart-item-remove {
        width: 28px; height: 28px; border-radius: 8px; border: none;
        background: #FEF2F2; color: #EF4444; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s; flex-shrink: 0;
    }
    .cart-item-remove:hover { background: #FEE2E2; }
    .cart-item-unit-price { font-size: 0.8rem; color: #9CA3AF; margin-top: 2px; }

    .cart-note-input { margin-top: 4px !important; font-size: 0.8rem; }

    .cart-item-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }

    .cart-qty-controls {
        display: flex; align-items: center; gap: 8px;
        background: #F9FAFB; border-radius: 10px; padding: 2px;
    }
    .cart-qty-btn {
        width: 30px; height: 30px; border-radius: 8px; border: none;
        background: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
        color: #374151; transition: all 0.15s; box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }
    .cart-qty-btn:hover { background: #F3F4F6; }
    .cart-qty-plus { background: #FF5500; color: white; }
    .cart-qty-plus:hover { background: #E64D00; }
    .cart-qty-value { font-weight: 800; font-size: 0.95rem; color: #111827; min-width: 24px; text-align: center; }
    .cart-item-total { font-weight: 800; font-size: 1.05rem; color: #FF5500; }

    /* Summary Card */
    .cart-summary-card {
        background: white; border-radius: 20px; padding: 20px;
        margin-top: 16px; border: 1px solid #F3F4F6;
        box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    }
    .cart-summary-title {
        font-family: 'Outfit', sans-serif; font-size: 1.1rem; font-weight: 700;
        color: #111827; margin: 0 0 16px;
    }
    .cart-summary-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 0.9rem; color: #6B7280; }
    .cart-summary-value { font-weight: 600; color: #374151; }
    .cart-summary-free { font-weight: 600; color: #10B981; }
    .cart-summary-divider { height: 1px; background: #F3F4F6; margin: 12px 0; }
    .cart-summary-total { font-size: 1.15rem; font-weight: 800; color: #111827; }

    .cart-table-input { margin: 16px 0 !important; }

    /* Submit Button */
    .cart-submit-btn {
        width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;
        padding: 14px; border-radius: 14px; border: none;
        background: linear-gradient(135deg, #FF5500, #FF7A33);
        color: white; font-weight: 700; font-size: 1rem; cursor: pointer;
        box-shadow: 0 6px 20px rgba(255,85,0,0.35);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .cart-submit-btn:hover { box-shadow: 0 8px 28px rgba(255,85,0,0.45); transform: translateY(-2px); }
    .cart-submit-btn:active { transform: scale(0.97); }
    .cart-submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .cart-submit-price {
        background: rgba(255,255,255,0.2); padding: 4px 12px;
        border-radius: 8px; font-weight: 800; margin-left: 4px;
    }
    .cart-submit-spinner {
        width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white; border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }
    @@keyframes spin { to { transform: rotate(360deg); } }
</style>

@code {
    private string TableNumber { get; set; } = "Masa 1";
    private bool isSubmitting = false;
    private bool isTableReadOnly = false;

    protected override async Task OnInitializedAsync()
    {
        // LocalStorage check for security
        try 
        {
            var storedTable = await JS.InvokeAsync<string>("localStorage.getItem", "verified_table");
            if (!string.IsNullOrEmpty(storedTable))
            {
                TableNumber = storedTable;
                isTableReadOnly = true;
                CartService.TableNumber = TableNumber;
            }
        }
        catch { /* Ignored */ }

        if (!isTableReadOnly)
        {
            if (!string.IsNullOrEmpty(CartService.TableNumber))
            {
                TableNumber = CartService.TableNumber;
                isTableReadOnly = true;
            }
            else
            {
                var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
                var query = uri.Query.TrimStart('?');
                var table = query.Split('&')
                                .Select(q => q.Split('='))
                                .FirstOrDefault(q => q.Length == 2 && q[0] == "table")?
                                .ElementAtOrDefault(1);

                if (!string.IsNullOrEmpty(table))
                {
                    TableNumber = $"Masa {table}";
                    // Don't lock purely based on URL query unless it's a token flow (handled above)
                    // But for legacy support we keep it editable or read-only based on preference.
                    // Let's keep it editable if just ?table=1, but lock if from localStorage
                }
            }
        }

        CartService.OnChange += StateHasChanged;
    }

    private async Task SubmitOrder()
    {
        if (string.IsNullOrWhiteSpace(TableNumber))
        {
            await JS.InvokeVoidAsync("alert", "L√ºtfen masa numaranƒ±zƒ± giriniz.");
            return;
        }

        isSubmitting = true;
        bool success = false;
        try
        {
            success = await CartService.SubmitOrder(TableNumber, Http);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Sipari≈ü g√∂nderilirken hata olu≈ütu: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }

        if (success)
        {
            await JS.InvokeVoidAsync("alert", "Sipari≈üiniz Mutfak Ekranƒ±na D√º≈üt√º! üë®‚Äçüç≥\nGarson onayladƒ±ƒüƒ±nda hazƒ±rlanmaya ba≈ülayacak.");
            Navigation.NavigateTo("/");
        }
    }

    public void Dispose()
    {
        CartService.OnChange -= StateHasChanged;
    }
}
